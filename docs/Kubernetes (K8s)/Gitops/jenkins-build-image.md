# C·∫•u h√¨nh lu·ªìng Jenkins Build Docker image v√† push l√™n Docker Hub

## 1. Gi·ªõi thi·ªáu

Trong b√†i vi·∫øt n√†y ch√∫ng ta s·∫Ω c√πng nhau t√¨m hi·ªÉu c√°ch build docker image tr√™n con Jenkins n√†y b·∫±ng c√¥ng c·ª• Kaniko.

### 1.1. **Run Docker in a Docker Container**

Nh∆∞ ch√∫ng ta ƒë√£ bi·∫øt, th√¨ b·∫£n ch·∫•t c·ªßa vi·ªác deploy Jenkins tr√™n c·ª•m Kubernetes l√† ch√∫ng ta ch·∫°y Jenkins master ·ªü dang 1 docker container (pod) v√† c√°c Agent s·∫Ω ƒë∆∞·ª£c t·∫°o khi c√°c pipeline chay. Agent ch√≠nh l√† docker container ƒë∆∞·ª£c ƒë√≥ng g√≥i trong pod.

Nh∆∞ v·∫≠y n·∫øu Pipeline c·ªßa ch√∫ng ta ch·∫°y task build docker image ch·∫≥ng h·∫°n, th√¨ s·∫Ω ph√°t sinh ra v·∫•n ƒë·ªÅ docker container c√≥ th·ªÉ ch·∫°y ƒë∆∞·ª£c c√°c l·ªánh docker ƒë·ªÉ l√†m nhi·ªám v·ª• build docker image kh√°c.

### 1.2. **Kaniko**

Kaniko l√† m·ªôt c√¥ng c·ª• m√£ ngu·ªìn m·ªü d√πng ƒë·ªÉ x√¢y d·ª±ng c√°c image Docker t·ª´ m·ªôt Dockerfile m√† kh√¥ng c·∫ßn s·ª≠ d·ª•ng daemon Docker. Kaniko c√≥ th·ªÉ ch·∫°y tr√™n b·∫•t k·ª≥ n·ªÅn t·∫£ng n√†o h·ªó tr·ª£ container, nh∆∞ Kubernetes, Google Cloud Build, Tekton, Jenkins, GitLab v√† nhi·ªÅu h∆°n n·ªØa. Kaniko gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v·ªÅ b·∫£o m·∫≠t v√† hi·ªáu su·∫•t khi x√¢y d·ª±ng c√°c image Docker tr√™n m√¥i tr∆∞·ªùng c·ªßa container.

!!! note "M·ªôt s·ªë t√≠nh nƒÉng ch√≠nh c·ªßa Kaniko"

    - H·ªó tr·ª£ x√¢y d·ª±ng c√°c image Docker t·ª´ c√°c ngu·ªìn kh√°c nhau, nh∆∞ local directory, Git repository, Google Cloud Storage, Amazon S3, v.v. 
    - H·ªó tr·ª£ ƒë·∫©y c√°c image Docker l√™n c√°c kho l∆∞u tr·ªØ kh√°c nhau, nh∆∞ Docker Hub, Google Container Registry, Amazon Elastic Container Registry, v.v.
    - H·ªó tr·ª£ s·ª≠ d·ª•ng c√°c bi·∫øn m√¥i tr∆∞·ªùng, c√°c tham s·ªë build-time v√† c√°c file c·∫•u h√¨nh ƒë·ªÉ t√πy bi·∫øn qu√° tr√¨nh x√¢y d·ª±ng image
    - H·ªó tr·ª£ s·ª≠ d·ª•ng cache ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô x√¢y d·ª±ng image v√† gi·∫£m dung l∆∞·ª£ng image
    - H·ªó tr·ª£ x√¢y d·ª±ng c√°c image ƒëa t·∫ßng (multi-stage) v√† k·∫ø th·ª´a t·ª´ c√°c image kh√°c
    - H·ªó tr·ª£ ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa Dockerfile v√† th√¥ng b√°o l·ªói n·∫øu c√≥

## 2. C·∫•u h√¨nh c√†i ƒë·∫∑t 

### 2.1. C√†i plugins tr√™n jenkins

V√†o Dashboard > Manage > Jenkins > Plugins

C√†i c√°c plugin sau:

- Kubernetes plugin
- Docker plugin

![gitops](images/plugin.png)

### 2.2. C·∫•u h√¨nh clouds ·ªü jenkins

V√†o Dashboard > Manage Jenkins > Clouds

N·∫øu ch∆∞a c√≥ Clouds, th√¨ ch·ªçn "New cloud" ƒë·ªÉ th√™m m·ªõi

![gitops](images/newcloud.png)

V√≠ d·ª• t√™n "kubernetes default" v√† ch·ªçn type "Kubernetes"

![gitops](images/newcloud1.png)

Ti·∫øp t·ª•c v√†o Dashboard > Manage Jenkins > Clouds > kubernetes default > Configure

C·∫•u h√¨nh c√°c tham s·ªë sau:

- **Name**: kubernetes default
- **Kubernetes URL**: https://kubernetes.default.svc
- **Kubernetes Namespace**: devops-tools
- **Jenkins URL**: http://jenkins-service:8080

!!! note "Trong ƒë√≥"

    - Name l√† t√™n
    - Kubernetes URL: l√† ƒë∆∞·ªùng d·∫´n c·ªßa Kubernetes
    - Kubernetes Namespace: l√† namespace c·ªßa jenkins ƒë∆∞·ª£c c√†i ƒë·∫∑t
    - Jenkins URL: l√† ƒë∆∞·ªùng d·∫´n c·ªßa service jenkins ƒë∆∞·ª£c c√†i ·ªü file deployment.yaml ·ªü b√†i vi·∫øt [c√†i jenkins](../C√†i ƒë·∫∑t K8S/C√†i ƒë·∫∑t jenkins.md) (The URL of the Jenkins Controller server.)

![gitops](images/configcloud.png)

![gitops](images/configcloud1.png)

Ti·∫øp t·ª•c v√†o Dashboard > Manage Jenkins > Clouds > kubernetes default > Pod Templates

Th√™m Add a pod template n·∫øu ch∆∞a c√≥

C·∫•u h√¨nh c√°c tham s·ªë sau:

- **Name**: kaniko
- **Namespace**: devops-tools
- **Labels**: docker-build
- **Usage**: Use this node as much as possible

- **Container Template**:
    - C·∫•u h√¨nh jnlp:
        - **Name**: jnlp
        - **Docker image**: jenkins/inbound-agent:alpine
        - **Working directory**: /home/jenkins/agent
        - **Command to run**: ƒë·ªÉ tr·ªëng
        - **Arguments to pass to the command**: tr·ªëng
        - **Allocate pseudo-TTY**: Kh√¥ng t√≠ch
    - C·∫•u h√¨nh kaniko:
       - **Name**: kaniko
       - **Docker image**: gcr.io/kaniko-project/executor:debug
       - **Working directory**: /home/jenkins/agent
       - **Command to run**: /busybox/cat
       - **Arguments to pass to the command**: Tr·ªëng 
       - **Allocate pseudo-TTY**: T√≠ch

- **Volumes**:
    - **Secret Volume**:
        - **Secret name**: kaniko-secret
        - **Mount path**: /kaniko/.docker


![gitops](images/pod1.png)

![gitops](images/pod2.png)

![gitops](images/pod3.png)

![gitops](images/pod4.png)

### 2.3. C·∫•u h√¨nh secret cho kaniko


```json linenums="1" title="config.json" 
{
    "auths": {
      "https://index.docker.io/v1/": {
        "auth": "XXXXXXXXXXXXXXXX"
      }
    }
  }
  
```

!!! note "Trong ƒë√≥"

     "auth" c√≥ c·∫•u tr√∫c nh∆∞ sau: base64(username:Personal access tokens c·ªßa docker hub). V√≠ d·ª• username l√† thaiphuoc1997, Personal access tokens c·ªßa docker hub l√† ABC123
     Th√¨ base64(thaiphuoc1997:ABC123) l√† dGhhaXBodW9jMTk5NzpBQkMxMjM=

     L·∫•y Personal access tokens c·ªßa docker hub ƒë∆∞·ª£c l·∫•y t·∫°i [personal-access-tokens](https://app.docker.com/settings/personal-access-tokens)
     

Sau ƒë√≥ tr√™n k8s ch·∫°y l·ªánh

```bash 
kubectl -n devops-tools create secret generic kaniko-secret --from-file=config.json
```

### 2.4. T√≠ch h·ª£p v√†o Jenkin pipeline

M√£ ngu·ªìn github: [https://github.com/vanphuoc9/complete-prodcution-e2e-pipeline.git](https://github.com/vanphuoc9/complete-prodcution-e2e-pipeline.git)



D∆∞·ªõi ƒë√¢y m√¨nh s·∫Ω gi·ªõi thi·ªáu v√≠ d·ª• ƒë∆°n gi·∫£n:




Ch√∫ng ta c·∫ßn t·∫°o 1 project, v·ªõi c√°c th√¥ng s·ªë c·∫•u h√¨nh nh∆∞ d∆∞·ªõi ƒë√¢y


![gitops](images/p1.png)

![gitops](images/p2.png)

![gitops](images/p3.png)

![gitops](images/p4.png)

![gitops](images/p5.png)


C√°c b∆∞·ªõc ƒë∆°n gi·∫£n:

- Checkout source code t·ª´ git
- Ch·∫°y pipeline v·ªõi c·∫•u h√¨nh ƒë∆∞·ª£c thi·∫øt l·∫≠p trong Jenkinsfile


```pipeline linenums="1"
pipeline {
    agent any
    options {
        skipDefaultCheckout()
    }
    parameters {
        string(name:'GIT_URL', defaultValue:'https://github.com/vanphuoc9/complete-prodcution-e2e-pipeline.git', description:'The URL of the source Git repository to use.')
        string(name:'GIT_BRANCH', defaultValue:'main', description:'The branch in the source Git repository to use.')
    }
    stages {
        stage("Checkout") {
            steps {
                checkout(changelog: false, poll: false, scm: [
                    $class: 'GitSCM',
                    branches: [
                        [name: params.GIT_BRANCH],
                    ],
                    doGenerateSubmoduleConfigurations: false,
                    submoduleCfg: [],
                    userRemoteConfigs: [
                        [
                            url: params.GIT_URL,
                        ],
                    ],
                ])
                stash name: 'sources', includes: '**', excludes: '**/.git,**/.git/**'
            }
        }
        stage("Build docker") {
            agent {
                label 'docker-build'
            }
            steps {
                unstash 'sources'
                container(name: 'kaniko') {
                    sh '/kaniko/executor --context=`pwd` --dockerfile=`pwd`/Dockerfile  --destination=thaiphuoc1997/testk8s:latest'
                }
            }
        }
    }
}
```

### 2.5. K·∫øt qu·∫£ build jenkins

```bash 
.....
Downloaded from central: https://repo.maven.apache.org/maven2/org/eclipse/aether/aether-util/1.0.0.v20140518/aether-util-1.0.0.v20140518.jar (146 kB at 2.4 MB/s)
[INFO] Installing /app/pom.xml to /root/.m2/repository/com/dmancloud/dinesh/demoapp/1.0.0/demoapp-1.0.0.pom
[INFO] Installing /app/target/demoapp.jar to /root/.m2/repository/com/dmancloud/dinesh/demoapp/1.0.0/demoapp-1.0.0.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  29.048 s
[INFO] Finished at: 2025-04-02T14:34:19Z
[INFO] ------------------------------------------------------------------------
[36mINFO[0m[0055] Taking snapshot of full filesystem...        
[36mINFO[0m[0062] Saving file app/target/demoapp.jar for later use 
[36mINFO[0m[0062] Deleting filesystem...                       
[36mINFO[0m[0063] Retrieving image manifest eclipse-temurin:17.0.6_10-jdk 
[36mINFO[0m[0063] Returning cached image manifest              
[36mINFO[0m[0063] Executing 0 build triggers                   
[36mINFO[0m[0063] Building stage 'eclipse-temurin:17.0.6_10-jdk' [idx: '1', base-idx: '-1'] 
[36mINFO[0m[0063] Unpacking rootfs as cmd COPY --from=build /app/target/demoapp.jar /app/ requires it. 
[36mINFO[0m[0078] WORKDIR /app                                 
[36mINFO[0m[0078] Cmd: workdir                                 
[36mINFO[0m[0078] Changed working directory to /app            
[36mINFO[0m[0078] Creating directory /app with uid -1 and gid -1 
[36mINFO[0m[0078] Taking snapshot of files...                  
[36mINFO[0m[0078] COPY --from=build /app/target/demoapp.jar /app/ 
[36mINFO[0m[0078] Taking snapshot of files...                  
[36mINFO[0m[0078] EXPOSE 8080                                  
[36mINFO[0m[0078] Cmd: EXPOSE                                  
[36mINFO[0m[0078] Adding exposed port: 8080/tcp                
[36mINFO[0m[0078] CMD ["java", "-jar","demoapp.jar"]           
[36mINFO[0m[0078] Pushing image to thaiphuoc1997/testk8s:latest 
[36mINFO[0m[0101] Pushed index.docker.io/thaiphuoc1997/testk8s@sha256:e1b75b3a4a1356d44a747e0d7092e99273ff607b473bf6d9945a28ab685db1ed 
[Pipeline] }
[Pipeline] // container
[Pipeline] }
[Pipeline] // node
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
Finished: SUCCESS
```

K·∫øt qu·∫£ jenkins ƒë√£ build source v√† ƒë·∫©y th√†nh c√¥ng image l√™n docker hub

![gitops](images/ketquajk.png)

**Nh∆∞ v·∫≠y jenkins ƒë√£ l·∫•y source t·ª´ github sau ƒë√≥ d√πng kaniko ƒë·ªÉ build Dockerfile c√≥ trong source, sau ƒë√≥ ƒë·∫©y image l√™n docker hub, b√†i vi·∫øt k·∫ø ti·∫øp m√¨nh s·∫Ω gi·ªõi thi·ªáu lu·ªìng k·∫ø ti·∫øp argocd d√πng image c·ªßa tr√™n docker hub ƒë·ªÉ deployment ·ª©ng d·ª•ng l√™n k8s**

## 3. T√†i li·ªáu tham kh·∫£o

- [Jenkins tr√™n Kubernetes: Build docker image b·∫±ng Kaniko](https://nvtienanh.info/blog/jenkins-tren-kubernetes-build-docker-image-bang-kaniko)
- [How to Install Jenkins in Kubernetes with Kaniko for Container Building](https://www.youtube.com/watch?v=qSK3HNirASU)